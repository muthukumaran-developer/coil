<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COIL v10 |Protocol Engine</title>
    
    <!-- Heavy Industry Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500;600&display=swap');

        :root {
            --bg-deep: #020617;
            --bg-surface: #0f172a;
            --border: #1e293b;
            --accent: #6366f1;
            --coil-green: #10b981;
            --json-orange: #f59e0b;
            --danger: #ef4444;
            --node-width: 340px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; 
            height: 100vh; 
            background: var(--bg-deep); 
            color: #f8fafc; 
        }

        /* --- LAYOUT SHELL --- */
        .app-shell { 
            display: grid; 
            grid-template-columns: 320px 1fr; 
            grid-template-rows: 64px 1fr auto; 
            height: 100vh; 
            width: 100vw;
        }

        .header { 
            grid-column: 1 / -1; 
            border-bottom: 1px solid var(--border); 
            background: #070b14; 
            z-index: 1000; 
            padding: 0 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar { 
            grid-column: 1;
            grid-row: 2 / 4;
            border-right: 1px solid var(--border); 
            background: #070b14; 
            overflow-y: auto; 
            padding: 25px;
            z-index: 900; 
        }

        /* --- FREESTYLE VIEWPORT ENGINE --- */
        .workspace { 
            grid-column: 2;
            grid-row: 2;
            position: relative; 
            overflow: hidden; 
            background: var(--bg-deep); 
        }
        
        #viewport { 
            width: 100%; 
            height: 100%; 
            position: absolute;
            inset: 0;
            overflow: hidden;
            cursor: crosshair;
        }

        #world { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            transform-origin: 0 0; /* Crucial for Zoom-at-Cursor Math */
            will-change: transform;
        }

        .grid-bg { 
            position: absolute; 
            inset: -50000px; 
            background-image: 
                radial-gradient(circle, #1e293b 1px, transparent 1px);
            background-size: 60px 60px; 
            z-index: -1; 
        }

        /* --- NODE UI --- */
        .node {
            position: absolute; 
            width: var(--node-width);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(15px); 
            border: 1px solid var(--border);
            border-radius: 28px; 
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.6);
            z-index: 10; 
            pointer-events: auto;
        }
        .node.selected { border: 2.5px solid var(--danger); box-shadow: 0 0 35px rgba(239, 68, 68, 0.4); }

        .port {
            width: 22px; height: 22px; background: #1e293b;
            border: 5px solid var(--bg-deep); border-radius: 50%;
            position: absolute; cursor: crosshair; z-index: 100;
            transition: transform 0.2s, background 0.2s;
        }
        .port:hover { background: var(--accent); transform: scale(1.3); }
        .port-in { left: -11px; top: 50%; transform: translateY(-50%); }
        .port-out { right: -11px; top: 50%; transform: translateY(-50%); }

        /* --- METRICS OVERLAYS --- */
        .metrics-grid {
            position: absolute; top: -150px; left: 0; width: 100%;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; pointer-events: none;
        }
        .m-card {
            background: rgba(7, 11, 20, 0.98); border: 1px solid var(--border);
            padding: 14px; border-radius: 18px; font-family: 'Fira Code', monospace;
        }
        .m-card.active { border-color: var(--coil-green); background: rgba(16, 185, 129, 0.1); }
        .m-head { font-size: 8px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; border-bottom: 1px solid #1e293b; padding-bottom: 3px;}
        .m-row { display: flex; justify-content: space-between; font-size: 10px; margin-top: 3px; }
        .m-lbl { color: #4b5563; }
        .m-val { font-weight: 700; color: #fff; }

        /* --- WIRE UI --- */
        .wire { fill: none; stroke: #334155; stroke-width: 4.5; stroke-linecap: round; pointer-events: auto; cursor: pointer; transition: stroke 0.2s; }
        .wire.selected { stroke: var(--danger) !important; filter: drop-shadow(0 0 10px var(--danger)); }
        .wire.flow-active { stroke: var(--coil-green); stroke-dasharray: 12; animation: dash 1s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: -24; } }

        .cable-hud {
            position: absolute; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; gap: 4px; pointer-events: none; z-index: 50;
        }
        .badge {
            background: rgba(2, 6, 23, 0.95); padding: 5px 12px; border-radius: 8px;
            font-family: 'Fira Code', monospace; font-size: 9px; border: 1px solid var(--border); white-space: nowrap;
        }

        /* --- BOTTOM MONITOR --- */
        #monitor { 
            grid-column: 2; height: 350px; background: #000; 
            border-top: 1px solid var(--border); display: flex; flex-direction: column; 
        }
        .mon-header { height: 52px; background: #070b14; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; border-bottom: 1px solid #1e293b; }
        .mon-body { flex: 1; display: flex; overflow: hidden; }
        .mon-col { flex: 1; border-right: 1px solid #1e293b; display: flex; flex-direction: column; }
        .mon-scroll { flex: 1; overflow-y: auto; padding: 25px; font-family: 'Fira Code', monospace; font-size: 11px; line-height: 1.7; }

        /* --- PROPERTIES DRAWER --- */
        .drawer {
            position: fixed; right: 0; top: 0; bottom: 0; width: 580px;
            background: #070b14; border-left: 1px solid var(--border); z-index: 2000;
            display: none; flex-direction: column; box-shadow: -40px 0 100px rgba(0,0,0,1);
        }

        .coil-token { color: var(--coil-green); font-weight: bold; }
        .coil-delim { color: #f43f5e; font-weight: bold; }

        #viewport-stats {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(15, 23, 42, 0.85); padding: 10px 20px;
            border-radius: 12px; font-family: 'Fira Code'; font-size: 11px;
            color: var(--accent); pointer-events: none; border: 1px solid var(--border); font-weight: bold;
            display: flex; gap: 20px;
        }
    </style>
</head>
<body>

    <div class="app-shell">
        
        <!-- HEADER -->
        <header class="header">
            <div class="flex items-center gap-6">
                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-indigo-500/30">
                    <i data-lucide="zap" class="text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter uppercase italic">COIL <span class="text-indigo-500 ml-2 font-normal text-sm normal-case italic">v10.0  </span></h1>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full bg-slate-500" id="sim-indicator"></span>
                            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest" id="sim-text">  Standby</p>
                        </div>
                        <div class="h-3 w-px bg-slate-800"></div>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Active Objects: <span id="obj-count" class="text-indigo-400">0</span></p>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="Sim.start()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-full font-black text-sm flex items-center gap-3 transition-all shadow-xl shadow-emerald-500/10">
                    <i data-lucide="play" class="w-5 h-5"></i> DEPLOY CLUSTER
                </button>
                <button onclick="Sim.stop()" class="bg-slate-800 hover:bg-red-600 text-white px-8 py-3 rounded-full font-black text-sm flex items-center gap-3 transition-all">
                    <i data-lucide="square" class="w-5 h-5"></i> TERMINATE
                </button>
            </div>
        </header>

        <!-- SIDEBAR -->
        <aside class="sidebar space-y-12">
            <div>
                <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-[0.3em] mb-6">Source Fabric</h3>
                <div draggable="true" ondragstart="Viewport.onDragStart(event, 'sensor')" class="p-6 bg-slate-800/20 border border-slate-700/50 rounded-[32px] cursor-grab hover:border-orange-500 transition-all group">
                    <div class="flex items-center gap-6">
                        <div class="p-4 bg-orange-500/10 text-orange-500 rounded-3xl group-hover:scale-110 transition-transform shadow-lg shadow-orange-500/10"><i data-lucide="database" class="w-8 h-8"></i></div>
                        <div>
                            <span class="block text-sm font-black uppercase">IoT Sensor</span>
                            <span class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Disk I/O Origin</span>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-[0.3em] mb-6">Logic Fabric</h3>
                <div class="space-y-4">
                    <div draggable="true" ondragstart="Viewport.onDragStart(event, 'server')" class="p-6 bg-slate-800/20 border border-slate-700/50 rounded-[32px] cursor-grab hover:border-blue-500 transition-all group">
                        <div class="flex items-center gap-6">
                            <div class="p-4 bg-blue-500/10 text-blue-500 rounded-3xl group-hover:scale-110 transition-transform shadow-lg shadow-blue-500/10"><i data-lucide="server" class="w-8 h-8"></i></div>
                            <div>
                                <span class="block text-sm font-black uppercase">Edge Gateway</span>
                                <span class="text-[9px] text-slate-500 uppercase font-black tracking-widest">RAM & Ops Filter</span>
                            </div>
                        </div>
                    </div>
                    <div draggable="true" ondragstart="Viewport.onDragStart(event, 'ai')" class="p-6 bg-slate-800/20 border border-slate-700/50 rounded-[32px] cursor-grab hover:border-pink-500 transition-all group">
                        <div class="flex items-center gap-6">
                            <div class="p-4 bg-pink-500/10 text-pink-500 rounded-3xl group-hover:scale-110 transition-transform shadow-lg shadow-pink-500/10"><i data-lucide="brain-circuit" class="w-8 h-8"></i></div>
                            <div>
                                <span class="block text-sm font-black uppercase">AI Inference</span>
                                <span class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Token Reduction</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-10 border-t border-slate-800/60">
                <div class="p-8 bg-indigo-600/5 rounded-[40px] border border-indigo-500/10">
                    <h4 class="text-[11px] font-black text-indigo-400 mb-4 uppercase tracking-widest">Aggregate Gain</h4>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-[10px] text-slate-500 font-black uppercase">Efficiency</span>
                        <span id="savings-val" class="text-4xl font-black text-emerald-500">0%</span>
                    </div>
                    <div class="h-2.5 bg-slate-800 rounded-full overflow-hidden">
                        <div id="savings-bar" class="h-full bg-emerald-500 w-0 transition-all duration-1000"></div>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-6 leading-relaxed font-bold italic">Roam: Right-Click / Middle-Click<br>Delete Node/Wire: [DEL] key</p>
                </div>
            </div>
        </aside>

        <!-- WORKSPACE -->
        <main class="workspace">
            <div id="viewport" ondragover="event.preventDefault()" ondrop="Viewport.onDrop(event)">
                <div id="world">
                    <div class="grid-bg"></div>
                    <svg id="wire-layer" class="absolute inset-0 pointer-events-none" style="min-width: 20000px; min-height: 20000px;">
                        <g id="wires-group"></g>
                        <path id="temp-wire" class="wire stroke-indigo-500/40" d="" style="display:none"></path>
                    </svg>
                    <div id="node-layer" class="absolute inset-0 pointer-events-none"></div>
                    <div id="hud-layer" class="absolute inset-0 pointer-events-none"></div>
                </div>
            </div>
            <div id="viewport-stats">
                <span>ZOOM: <span id="zoom-val">100%</span></span>
                <span>PAN: <span id="pan-val">0, 0</span></span>
            </div>
        </main>

        <!-- MONITOR -->
        <section id="monitor">
            <div class="mon-header">
                <div class="flex items-center gap-10">
                    <span class="text-[11px] font-black uppercase tracking-widest text-slate-400">Distributed Packet Inspector</span>
                    <div class="flex gap-8">
                        <span id="mon-json-sz" class="text-[11px] font-mono text-orange-500 font-black bg-orange-500/10 px-3 py-1 rounded-lg">JSON: 0.00 KB</span>
                        <span id="mon-coil-sz" class="text-[11px] font-mono text-emerald-500 font-black bg-emerald-500/10 px-3 py-1 rounded-lg">COIL: 0.00 KB</span>
                    </div>
                </div>
                <button onclick="Viewport.toggleMonitor()" class="text-slate-500 hover:text-white transition-all"><i data-lucide="chevron-down" id="mon-toggle-icon"></i></button>
            </div>
            <div class="mon-body">
                <div class="mon-col">
                    <div class="px-8 py-3 bg-slate-900 border-b border-slate-800 text-[10px] font-black text-slate-500 uppercase tracking-widest">RFC-Compliant JSON Stream</div>
                    <div id="log-json" class="mon-scroll text-orange-400/60"></div>
                </div>
                <div class="mon-col">
                    <div class="px-8 py-3 bg-slate-900 border-b border-slate-800 text-[10px] font-black text-slate-500 uppercase tracking-widest">COIL Encoded Stream (Zenith)</div>
                    <div id="log-coil" class="mon-scroll"></div>
                </div>
            </div>
        </section>

    </div>

    <!-- PROPERTY DRAWER -->
    <div id="prop-drawer" class="drawer">
        <div class="p-12 border-b border-slate-800 flex justify-between items-center bg-slate-900/30">
            <div>
                <h2 class="font-black text-3xl uppercase tracking-tighter italic text-indigo-500">Node Logic</h2>
                <p class="text-[11px] text-slate-500 uppercase font-black tracking-widest mt-1">Simulated Hardware Registry</p>
            </div>
            <button onclick="Viewport.closeProps()" class="p-4 hover:bg-slate-800 rounded-3xl transition-all"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <div id="prop-content" class="flex-1 overflow-y-auto p-12 space-y-10"></div>
        <div class="p-12 border-t border-slate-800 bg-slate-950">
            <button onclick="Viewport.saveProps()" class="w-full py-6 bg-indigo-600 hover:bg-indigo-500 text-white rounded-3xl font-black text-base uppercase tracking-widest shadow-2xl shadow-indigo-600/30">
                Update Profile
            </button>
        </div>
    </div>

    <script>
        /**
         * COIL   ENGINE
         */
        const COIL = {
            REC: ",", PAIR: "|",
            encode(payload) {
                if (!Array.isArray(payload)) payload = [payload];
                const keys = _.uniq(_.flatten(payload.map(r => Object.keys(r)))).sort();
                const freqs = {};
                payload.forEach(row => keys.forEach(k => {
                    const v = String(row[k] ?? "");
                    if (v.length > 2) freqs[v] = (freqs[v] || 0) + 1;
                }));
                const vmap = {}; let count = 1;
                Object.entries(freqs).filter(([v, f]) => f > 1).sort((a,b) => b[1] - a[1]).slice(0, 50).forEach(([v]) => vmap[v] = `V${count++}`);
                const rows = payload.map(row => keys.map(k => vmap[String(row[k] ?? "")] || String(row[k] ?? "")).join(this.PAIR));
                const meta = `META&K=${keys.join(";")}&V=${Object.entries(vmap).map(([v,t])=>`${t}:${v}`).join(",")}`;
                const body = `BODY${this.REC}B[${payload.length}]${this.REC}${rows.join(this.REC)}`;
                const full = meta + "|" + body;
                return { full, size: full.length, rawSize: JSON.stringify(payload).length, savings: (((JSON.stringify(payload).length - full.length) / JSON.stringify(payload).length) * 100).toFixed(1) };
            },
            format(str) {
                return str.replace(/,/g, '<span class="coil-delim">,</span>').replace(/\|/g, '<span class="coil-delim">|</span>').replace(/(V\d+)/g, '<span class="coil-token">$1</span>');
            }
        };

        const HW_PROFILES = {
            'gpt4': { name: 'GPT-4 (cl100k)', ratio: 3.8 },
            'claude': { name: 'Claude-3.5 (Sonnet)', ratio: 3.5 },
            'llama': { name: 'Llama-3 (Meta)', ratio: 4.1 }
        };

        /**
         * SIMULATION ENGINE
         */
        const Sim = {
            nodes: [], wires: [], isRunning: false, tickId: null,
            selectedId: null,

            start() {
                this.isRunning = true;
                this.setIndicator(true);
                this.tickId = setInterval(() => this.tick(), 2500);
            },

            stop() {
                this.isRunning = false;
                this.setIndicator(false);
                clearInterval(this.tickId);
                Viewport.clearMetrics();
                Viewport.drawWires();
            },

            tick() {
                // Collector Buffer Reset
                this.nodes.forEach(n => n.buffer = []);
                
                // Sensor Propagation
                this.nodes.filter(n => n.type === 'sensor').forEach(n => {
                    const data = this.generateSensorData(n);
                    this.propagate(n.id, data);
                });
                
                document.getElementById('obj-count').innerText = this.nodes.length + this.wires.length;
            },

            generateSensorData(node) {
                try {
                    const base = JSON.parse(node.config.payload || "[]");
                    const burst = [];
                    for(let i=0; i<(node.config.repeats || 5); i++) {
                        base.forEach(item => {
                            const row = {...item};
                            Object.keys(row).forEach(k => { if(typeof row[k] === 'number') row[k] += (Math.random()*2 - 1); });
                            burst.push(row);
                        });
                    }
                    return burst;
                } catch(e) { return []; }
            },

            propagate(nodeId, data) {
                const node = this.nodes.find(n => n.id === nodeId);
                if(!node || !data.length) return;

                const jsonStr = JSON.stringify(data);
                const coilRes = COIL.encode(data);
                
                const stats = {
                    json: { size: jsonStr.length / 1024, chars: jsonStr.length },
                    coil: { size: coilRes.size / 1024, chars: coilRes.full.length }
                };

                if(node.type === 'ai') {
                    const r = HW_PROFILES[node.config.model || 'gpt4'].ratio;
                    stats.json.tokens = Math.ceil(jsonStr.length / r);
                    stats.coil.tokens = Math.ceil(coilRes.size / r);
                } else {
                    stats.json.ram = (jsonStr.length / 256).toFixed(1);
                    stats.coil.ram = (coilRes.size / 256).toFixed(1);
                    stats.ops = Math.ceil(data.length * 3.5);
                }

                Viewport.updateNodeMetrics(nodeId, stats, node.type);
                if(node.type === 'sensor') Viewport.updateMonitor(jsonStr, coilRes, stats);

                this.wires.filter(w => w.from === nodeId).forEach(w => {
                    Viewport.animatePulse(w.id, stats);
                    const target = this.nodes.find(n => n.id === w.to);
                    if(!target) return;
                    
                    // Collector Pattern
                    target.buffer = (target.buffer || []).concat(data);
                    setTimeout(() => {
                        let processed = target.buffer;
                        if(target.type === 'server' && target.config.filter) {
                            try { processed = new Function('data', target.config.filter)(processed); } catch(e) {}
                        }
                        this.propagate(target.id, processed);
                    }, 400);
                });
            },

            setIndicator(active) {
                const dot = document.getElementById('sim-indicator');
                const txt = document.getElementById('sim-text');
                dot.className = `w-2.5 h-2.5 rounded-full ${active ? 'bg-emerald-500 animate-pulse' : 'bg-slate-500'}`;
                txt.innerText = active ? 'ZENITH   Active' : '  Standby';
                Viewport.drawWires();
            }
        };

        /**
         * VIEWPORT & UI ENGINE (FREESTYLE)
         */
        const Viewport = {
            cam: { x: 0, y: 0, zoom: 1 },
            isPanning: false,
            panStart: { x: 0, y: 0 },
            isWiring: false,
            wireStartId: null,
            ace: null,
            monitorOpen: true,

            init() {
                lucide.createIcons();
                this.bindEvents();
                this.spawnNode('sensor', 100, 200);
                this.spawnNode('ai', 1000, 200);
            },

            bindEvents() {
                const vp = document.getElementById('viewport');

                // --- ZOOM AT CURSOR MATH ---
                vp.onwheel = (e) => {
                    e.preventDefault();
                    const rect = vp.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;

                    // World Coordinates of mouse before zoom
                    const worldX = (mouseX - this.cam.x) / this.cam.zoom;
                    const worldY = (mouseY - this.cam.y) / this.cam.zoom;

                    const zoomDelta = e.deltaY > 0 ? 0.9 : 1.1;
                    const newZoom = Math.min(Math.max(this.cam.zoom * zoomDelta, 0.05), 3);
                    
                    this.cam.zoom = newZoom;
                    
                    // Adjust translate so world coordinates remain under mouse
                    this.cam.x = mouseX - worldX * this.cam.zoom;
                    this.cam.y = mouseY - worldY * this.cam.zoom;

                    this.updateTransform();
                };

                // --- FREESTYLE PANNING ---
                vp.onmousedown = (e) => {
                    if(e.button === 2 || e.button === 1) { 
                        this.isPanning = true;
                        this.panStart = { x: e.clientX - this.cam.x, y: e.clientY - this.cam.y };
                        vp.style.cursor = 'grabbing';
                    }
                };

                window.onmousemove = (e) => {
                    if(this.isPanning) {
                        this.cam.x = e.clientX - this.panStart.x;
                        this.cam.y = e.clientY - this.panStart.y;
                        this.updateTransform();
                    }
                    if(this.isWiring) this.drawWireGhost(e);
                };

                window.onmouseup = () => {
                    this.isPanning = false;
                    vp.style.cursor = 'crosshair';
                };

                // --- GLOBAL DELETION (DELETE KEY ONLY) ---
                window.onkeydown = (e) => {
                    if(e.key === 'Delete' && Sim.selectedId) {
                        // Prevent deletion when typing in inputs/Ace
                        if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) || document.activeElement.closest('.ace_editor')) return;

                        const sid = Sim.selectedId;
                        if(sid.startsWith('n_')) {
                            Sim.nodes = Sim.nodes.filter(n => n.id !== sid);
                            Sim.wires = Sim.wires.filter(w => w.from !== sid && w.to !== sid);
                            document.getElementById(sid).remove();
                        } else {
                            Sim.wires = Sim.wires.filter(w => w.id !== sid);
                        }
                        Sim.selectedId = null;
                        this.drawWires();
                    }
                };

                vp.oncontextmenu = (e) => e.preventDefault();
            },

            updateTransform() {
                const world = document.getElementById('world');
                world.style.transform = `translate(${this.cam.x}px, ${this.cam.y}px) scale(${this.cam.zoom})`;
                document.getElementById('zoom-val').innerText = `${Math.round(this.cam.zoom * 100)}%`;
                document.getElementById('pan-val').innerText = `${Math.round(this.cam.x)}, ${Math.round(this.cam.y)}`;
            },

            onDragStart(e, type) { e.dataTransfer.setData('nodeType', type); },
            
            onDrop(e) {
                e.preventDefault();
                const type = e.dataTransfer.getData('nodeType');
                const rect = document.getElementById('viewport').getBoundingClientRect();
                
                // MATH: Convert Screen Drop to World Space
                const worldX = (e.clientX - rect.left - this.cam.x) / this.cam.zoom - 170;
                const worldY = (e.clientY - rect.top - this.cam.y) / this.cam.zoom - 60;
                
                this.spawnNode(type, worldX, worldY);
            },

            spawnNode(type, x, y) {
                const id = 'n_' + Date.now() + Math.floor(Math.random()*100);
                const node = { id, type, x, y, config: this.getDefaultConfig(type), buffer: [] };
                Sim.nodes.push(node);
                this.renderNode(node);
            },

            getDefaultConfig(type) {
                const base = { name: type.toUpperCase() + '  ', model: 'gpt4' };
                if(type === 'sensor') return { ...base, payload: '[{"id":1,"temp":24,"val":10}]', repeats: 10 };
                if(type === 'server') return { ...base, filter: 'return data.filter(x => x.id > 0);' };
                return base;
            },

            renderNode(node) {
                const div = document.createElement('div');
                div.id = node.id;
                div.className = 'node pointer-events-auto';
                div.style.left = node.x + 'px';
                div.style.top = node.y + 'px';

                const icon = {sensor:'database', server:'server', ai:'brain-circuit'}[node.type];

                div.innerHTML = `
                    <div class="metrics-grid" id="met-${node.id}"></div>
                    <div class="p-8 border-b border-slate-800 flex items-center justify-between bg-slate-900/40 rounded-t-[28px]">
                        <div class="flex items-center gap-4">
                            <i data-lucide="${icon}" class="w-5 h-5 text-indigo-400"></i>
                            <span class="text-[12px] font-black uppercase text-slate-200 tracking-wider">${node.config.name}</span>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="h-1 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-indigo-500 w-0 transition-all duration-300 sim-bar"></div>
                        </div>
                    </div>
                    ${node.type !== 'sensor' ? `<div class="port port-in" data-port-in="${node.id}"></div>` : ''}
                    ${node.type !== 'ai' ? `<div class="port port-out" onmousedown="Viewport.startWire(event, '${node.id}')"></div>` : ''}
                `;

                // --- DRAGGING ENGINE (WORLD COMPENSATED) ---
                let isDragging = false;
                let dragOffset = { x: 0, y: 0 };

                div.onmousedown = (e) => {
                    if(e.target.classList.contains('port')) return;
                    isDragging = true;
                    Sim.selectedId = node.id;
                    dragOffset = { x: e.clientX / this.cam.zoom - node.x, y: e.clientY / this.cam.zoom - node.y };
                    document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
                    div.classList.add('selected');
                    e.stopPropagation();
                };

                window.addEventListener('mousemove', (e) => {
                    if(!isDragging) return;
                    node.x = (e.clientX / this.cam.zoom - dragOffset.x);
                    node.y = (e.clientY / this.cam.zoom - dragOffset.y);
                    div.style.left = node.x + 'px';
                    div.style.top = node.y + 'px';
                    this.drawWires();
                });

                window.addEventListener('mouseup', () => isDragging = false);
                div.ondblclick = () => this.openProps(node.id);

                document.getElementById('node-layer').appendChild(div);
                lucide.createIcons();
            },

            startWire(e, id) {
                e.stopPropagation();
                this.isWiring = true;
                this.wireStartId = id;
                document.getElementById('temp-wire').style.display = 'block';
            },

            drawWireGhost(e) {
                const n = Sim.nodes.find(node => node.id === this.wireStartId);
                const rect = document.getElementById('viewport').getBoundingClientRect();
                const x1 = n.x + 340;
                const y1 = n.y + 60;
                // Convert mouse screen space to world space for ghost
                const x2 = (e.clientX - rect.left - this.cam.x) / this.cam.zoom;
                const y2 = (e.clientY - rect.top - this.cam.y) / this.cam.zoom;

                document.getElementById('temp-wire').setAttribute('d', `M ${x1} ${y1} C ${x1+150} ${y1}, ${x2-150} ${y2}, ${x2} ${y2}`);

                const target = document.elementFromPoint(e.clientX, e.clientY);
                if(target?.dataset.portIn) {
                    const toId = target.dataset.portIn;
                    if(toId !== this.wireStartId) {
                        this.isWiring = false;
                        document.getElementById('temp-wire').style.display = 'none';
                        if(!Sim.wires.find(w => w.from === this.wireStartId && w.to === toId)) {
                            Sim.wires.push({ id: 'w_' + Date.now(), from: this.wireStartId, to: toId });
                        }
                        this.drawWires();
                    }
                }
            },

            drawWires() {
                const g = document.getElementById('wires-group');
                const hud = document.getElementById('hud-layer');
                g.innerHTML = ''; hud.innerHTML = '';

                Sim.wires.forEach(w => {
                    const n1 = Sim.nodes.find(n => n.id === w.from);
                    const n2 = Sim.nodes.find(n => n.id === w.to);
                    if(!n1 || !n2) return;

                    const x1 = n1.x + 340, y1 = n1.y + 60;
                    const x2 = n2.x, y2 = n2.y + 60;
                    const d = `M ${x1} ${y1} C ${x1+150} ${y1}, ${x2-150} ${y2}, ${x2} ${y2}`;

                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute('d', d);
                    path.setAttribute('class', `wire ${Sim.isRunning ? 'flow-active' : ''} ${Sim.selectedId === w.id ? 'selected' : ''}`);
                    path.onclick = (e) => { Sim.selectedId = w.id; this.drawWires(); e.stopPropagation(); };
                    g.appendChild(path);

                    const badge = document.createElement('div');
                    badge.id = `badge-${w.id}`;
                    badge.className = 'cable-hud';
                    badge.style.left = (x1+x2)/2 + 'px';
                    badge.style.top = (y1+y2)/2 + 'px';
                    hud.appendChild(badge);
                });
            },

            updateNodeMetrics(id, stats, type) {
                const el = document.getElementById(`met-${id}`);
                const nodeEl = document.getElementById(id);
                if(!el) return;

                const coilBetter = stats.coil.size < stats.json.size;
                const bar = nodeEl.querySelector('.sim-bar');
                bar.style.width = '100%'; setTimeout(() => bar.style.width = '0%', 1200);

                const renderSection = (mode) => {
                    const d = stats[mode];
                    let h = `<div class="m-row"><span class="m-lbl">SIZE</span><span class="m-val">${d.size.toFixed(2)} KB</span></div>`;
                    if(type === 'ai') {
                        h += `<div class="m-row"><span class="m-lbl">CHAR</span><span class="m-val">${d.chars}</span></div>`;
                        h += `<div class="m-row"><span class="m-lbl">TOKEN</span><span class="m-val">${d.tokens}</span></div>`;
                    } else {
                        h += `<div class="m-row"><span class="m-lbl">RAM</span><span class="m-val">${d.ram} MB</span></div>`;
                        h += `<div class="m-row"><span class="m-lbl">COMP</span><span class="m-val">${stats.ops}</span></div>`;
                    }
                    return h;
                };

                el.innerHTML = `
                    <div class="m-card ${!coilBetter ? 'active' : ''}"><span class="m-head">Standard</span>${renderSection('json')}</div>
                    <div class="m-card ${coilBetter ? 'active' : ''}"><span class="m-head">Zenith</span>${renderSection('coil')}</div>
                `;
            },

            animatePulse(wireId, stats) {
                const b = document.getElementById(`badge-${wireId}`);
                if(!b) return;
                const util = (stats.coil.size * 6.5).toFixed(1);
                b.innerHTML = `
                    <div class="badge text-orange-400">JSON: ${(stats.json.size).toFixed(1)}K | ${(stats.json.size*6).toFixed(0)}ms</div>
                    <div class="badge text-emerald-400">COIL: ${(stats.coil.size).toFixed(1)}K | ${(stats.coil.size*2).toFixed(0)}ms | BW: ${util}%</div>
                `;
            },

            updateMonitor(json, coil, stats) {
                document.getElementById('log-json').innerHTML = `<pre>${JSON.stringify(JSON.parse(json), null, 2)}</pre>`;
                document.getElementById('log-coil').innerHTML = `<div class="break-all">${COIL.format(coil.full)}</div>`;
                document.getElementById('mon-json-sz').innerText = `JSON: ${stats.json.size.toFixed(2)} KB`;
                document.getElementById('mon-coil-sz').innerText = `COIL: ${stats.coil.size.toFixed(2)} KB`;
                const s = (((stats.json.size - stats.coil.size) / stats.json.size) * 100).toFixed(1);
                document.getElementById('savings-val').innerText = s + '%';
                document.getElementById('savings-bar').style.width = s + '%';
            },

            openProps(id) {
                const node = Sim.nodes.find(n => n.id === id);
                Sim.selectedId = node.id;
                const drawer = document.getElementById('prop-drawer');
                const content = document.getElementById('prop-content');
                drawer.style.display = 'flex';

                let html = `
                    <div class="mb-8">
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Logic Hardware Tag</label>
                        <input id="p-name" type="text" value="${node.config.name}" class="w-full bg-slate-800 border border-slate-700 p-5 rounded-2xl text-white font-bold text-lg">
                    </div>
                `;

                if(node.type === 'ai') {
                    html += `
                        <div class="mb-8">
                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Tokenization Model</label>
                            <select id="p-model" class="w-full bg-slate-800 border border-slate-700 p-5 rounded-2xl text-white font-bold text-lg">
                                ${Object.entries(HW_PROFILES).map(([k,v]) => `<option value="${k}" ${node.config.model === k ? 'selected' : ''}>${v.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }

                if(node.type === 'sensor') {
                    html += `
                        <div class="mb-8">
                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Packet Repetitions</label>
                            <input id="p-repeats" type="number" value="${node.config.repeats}" class="w-full bg-slate-800 border border-slate-700 p-5 rounded-2xl text-white font-bold text-lg">
                        </div>
                        <div class="mb-8">
                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">JSON Blueprint</label>
                            <div id="ace-ed" style="height: 300px;" class="rounded-2xl border border-slate-700"></div>
                        </div>
                    `;
                }

                if(node.type === 'server') {
                    html += `
                        <div class="mb-8">
                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Logic Sandbox (JS)</label>
                            <p class="text-[9px] text-slate-600 mb-2 font-black uppercase tracking-widest">Available Variable: 'data' (Array)</p>
                            <div id="ace-ed" style="height: 300px;" class="rounded-2xl border border-slate-700"></div>
                        </div>
                    `;
                }

                content.innerHTML = html;
                if(node.type !== 'ai') {
                    this.ace = ace.edit("ace-ed");
                    this.ace.setTheme("ace/theme/tomorrow_night_eighties");
                    this.ace.session.setMode(node.type === 'sensor' ? "ace/mode/json" : "ace/mode/javascript");
                    this.ace.setValue(node.type === 'sensor' ? node.config.payload : node.config.filter, -1);
                }
            },

            saveProps() {
                const n = Sim.nodes.find(node => node.id === Sim.selectedId);
                n.config.name = document.getElementById('p-name').value;
                if(n.type === 'ai') n.config.model = document.getElementById('p-model').value;
                if(n.type === 'sensor') { n.config.repeats = parseInt(document.getElementById('p-repeats').value); n.config.payload = this.ace.getValue(); }
                if(n.type === 'server') { n.config.filter = this.ace.getValue(); }
                
                // CRITICAL FIX: Only update the label, don't re-render.
                document.getElementById(n.id).querySelector('span').innerText = n.config.name;
                this.closeProps();
            },

            closeProps() { document.getElementById('prop-drawer').style.display = 'none'; },
            clearMetrics() { document.querySelectorAll('.metrics-grid, .cable-hud').forEach(el => el.innerHTML = ''); },
            toggleMonitor() {
                const m = document.getElementById('monitor');
                const i = document.getElementById('mon-toggle-icon');
                this.monitorOpen = !this.monitorOpen;
                m.style.height = this.monitorOpen ? '350px' : '52px';
                i.setAttribute('data-lucide', this.monitorOpen ? 'chevron-down' : 'chevron-up');
                lucide.createIcons();
            }
        };

        window.onload = () => Viewport.init();
    </script>
</body>
</html>